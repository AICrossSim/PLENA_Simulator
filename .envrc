# =============================================================================
# Nix & Direnv Configuration for PLENA Simulator
# =============================================================================

# Source nix profile if available
if [ -f ~/.nix-profile/etc/profile.d/nix.sh ]; then
    source ~/.nix-profile/etc/profile.d/nix.sh
fi

use flake

# =============================================================================
# Python Virtual Environment Setup (via uv)
# =============================================================================

PYTHON_VERSION="python3.12"
VENV_DIR="$PWD/.venv"

# Create virtual environment if it doesn't exist
if [ ! -d "$VENV_DIR" ]; then
    log_status "Creating Python virtual environment..."
    uv venv --python "$PYTHON_VERSION"
fi

export VIRTUAL_ENV="$VENV_DIR"
export PATH="$VIRTUAL_ENV/bin:$PATH"

# Install dependencies from pyproject.toml
if [ ! -f "$VENV_DIR/.deps-installed" ]; then
    log_status "Installing Python dependencies..."

    # Sync dependencies + install project in editable mode
    uv sync
    uv pip install -e .

    touch "$VENV_DIR/.deps-installed"
    log_status "Dependencies installed successfully"
fi



# Add tools directory to Python path so quant module can be found
export PYTHONPATH="$PWD/tools:${PYTHONPATH:-}"

# Find the actual PyTorch library path
TORCH_LIB_PATH=$(python -c "import torch; print(torch.utils.cmake_prefix_path + '/lib')" 2>/dev/null || echo "$PWD/.venv/lib/python3.12/site-packages/torch/lib")

# Use PyTorch pre-built library to avoid supplying our own.
export LIBTORCH_USE_PYTORCH=1
export LIBTORCH_BYPASS_VERSION_CHECK=1

# Add GCC C++ standard library and PyTorch library paths,
# as they need newer libstdc++ now available on RHEL 9.5
GCC_LIB_PATH=$(nix-build '<nixpkgs>' -A gcc.cc.lib --no-out-link 2>/dev/null)/lib
ZLIB_LIB_PATH=$(nix-build '<nixpkgs>' -A zlib --no-out-link 2>/dev/null)/lib

# Set library paths for both runtime and linking
export LD_LIBRARY_PATH="/run/opengl-driver/lib:${TORCH_LIB_PATH}:${GCC_LIB_PATH}:${ZLIB_LIB_PATH}:${LD_LIBRARY_PATH:-}"
# export LD_PRELOAD=/lib/x86_64-linux-gnu/libcuda.so.1

echo "Using PyTorch libraries from: ${TORCH_LIB_PATH}"