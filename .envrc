# Source nix is available first
if [ -f ~/.nix-profile/etc/profile.d/nix.sh ]; then
    source ~/.nix-profile/etc/profile.d/nix.sh
fi

use flake

# Use UV to create venv if there isn't any
if [ ! -e .venv ]; then
    uv venv --python python3.12  # Use Python 3.12
fi

export VIRTUAL_ENV="$PWD/.venv"
export PATH="$VIRTUAL_ENV/bin:$PATH"

if [ ! -f .venv/.deps-installed ]; then
    # Install PyTorch with CUDA support; adjust cuda version if you need a different one
    uv pip install torch==2.7.1+cu126 --extra-index-url https://download.pytorch.org/whl/cu126
    uv pip install numpy
    uv pip install bitstring  # For bit manipulation operations
    uv pip install colorlog  # For colored logging output
    uv pip install toml  # For TOML configuration file parsing
    uv pip install tqdm
    uv pip install kernels
    uv pip install pytest
    uv pip install transformers
    uv pip install matplotlib

    # uv pip install fast_hadamard_transform --no-build-isolation
    uv pip install -e . || echo "Warning: Could not install main project"

    touch .venv/.deps-installed
fi



# Add tools directory to Python path so quant module can be found
export PYTHONPATH="$PWD/tools:${PYTHONPATH:-}"

# Find the actual PyTorch library path
TORCH_LIB_PATH=$(python -c "import torch; print(torch.utils.cmake_prefix_path + '/lib')" 2>/dev/null || echo "$PWD/.venv/lib/python3.12/site-packages/torch/lib")

# Use PyTorch pre-built library to avoid supplying our own.
export LIBTORCH_USE_PYTORCH=1
export LIBTORCH_BYPASS_VERSION_CHECK=1

# Add GCC C++ standard library and PyTorch library paths,
# as they need newer libstdc++ now available on RHEL 9.5
GCC_LIB_PATH=$(nix-build '<nixpkgs>' -A gcc.cc.lib --no-out-link 2>/dev/null)/lib
ZLIB_LIB_PATH=$(nix-build '<nixpkgs>' -A zlib --no-out-link 2>/dev/null)/lib

# Set library paths for both runtime and linking
export LD_LIBRARY_PATH="/run/opengl-driver/lib:${TORCH_LIB_PATH}:${GCC_LIB_PATH}:${ZLIB_LIB_PATH}:${LD_LIBRARY_PATH:-}"
# export LD_PRELOAD=/lib/x86_64-linux-gnu/libcuda.so.1

echo "Using PyTorch libraries from: ${TORCH_LIB_PATH}"